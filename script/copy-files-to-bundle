#!/bin/sh
# This can only be run by xcode or xcodebuild!

# Because of the way xcodebuild invokes external scripts we need to load
# The Setup's environment ourselves. If this isn't done, things like the
# node shim won't be able to find the stuff they need.

if [ -f /opt/github/env.sh ]; then
  source /opt/github/env.sh
fi

RESOUCES_PATH="$BUILT_PRODUCTS_DIR/$UNLOCALIZED_RESOURCES_FOLDER_PATH"
mkdir -p "$RESOUCES_PATH/v8_extensions"
cp "$PROJECT_DIR/native/v8_extensions/"*.js "$RESOUCES_PATH/v8_extensions/"

for DIR in src static vendor spec benchmark bundles themes; do
  rm -rf "$RESOUCES_PATH/$DIR"
  cp -R "$DIR" "$RESOUCES_PATH/"
  if ! node_modules/.bin/coffee -c "$RESOUCES_PATH/$DIR"; then
    echo "ERROR: Failed to comile scripts at '$RESOUCES_PATH/$DIR'"
    exit 1
 fi
done;
